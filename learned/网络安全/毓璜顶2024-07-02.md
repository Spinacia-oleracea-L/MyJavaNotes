# 允许Traceroute探测

http://t.csdnimg.cn/A3eSj

描述：本插件使用Traceroute探测来获取扫描器与远程主机之间的路由信息。攻击者也可以利用这些信息来了解目标网络的网络拓扑。

运维建议解决方案：在防火墙中禁用Time Exceeded类型的ICMP包
端口号：0

如果 /etc/sysconfig/ 目录下没有 iptables 文件（就是iptables，而不是iptables-config），需要安装 iptables，安装参考链接：https://www.cnblogs.com/miracle-luna/p/13714709.html

检验系统中有没有iptables服务

```bash
1、停止 firewall 服务
systemctl stop firewalld 
 
2、注销 firewall 服务
systemctl mask firewalld
 
3、安装 iptables 服务
yum install -y iptables 
yum install iptables-services
 
4、启动 iptables 服务
systemctl start iptables
或者
service iptables start
 
5、设置 iptables 开机自启动
systemctl enable iptables
 
6、查看 iptables 状态
systemctl status iptables
或者
service iptables status

```

有了iptables 文件后，修改 iptables 文件
在/etc/sysconfig/iptables 文件中，增加如下文字内容：

```shell
#sample configuration for iptables service
#you can edit this manually or use system-config-firewall
#please do not ask us to add additional ports/services to this default configuration*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT

#解决time exceeded问题
-A INPUT -p icmp --icmp-type time-exceeded -j DROP
-A OUTPUT -p icmp --icmp-type time-exceeded -j DROP

-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```

保存、重载、重启、查看 iptables 状态

```bash
#保存
service iptables save
#重载
service iptables reload或者systemctl reload iptables
#重启（未启动的话就启动）
service iptables restart或者systemctl restart iptables
#开机自启（是否需要开机自启还得商讨）
systemctl enable iptables
#查看状态
service iptables status或者systemctl status iptables
```



# ICMP  timestamp请求响应漏洞

## 方案一

在CentOS系统上进行防火墙配置以过滤外来的ICMP timestamp请求和外发ICMP timestamp响应报文的操作步骤如下：

1. **查看当前防火墙规则**：

   ```
   sudo iptables -L
   ```

2. **添加规则过滤外来ICMP timestamp请求**：

   ```
   sudo iptables -A INPUT -p icmp --icmp-type 13 -j DROP
   ```

3. **添加规则过滤外发ICMP timestamp响应**：

   ```
   sudo iptables -A OUTPUT -p icmp --icmp-type 14 -j DROP
   ```

4. **保存规则**：

   ```
   sudo service iptables save
   ```

5. **重启防火墙**：

   ```
   sudo service iptables restart
   ```

6. **验证规则是否生效**：
   可以再次运行以下命令来查看当前的防火墙规则，确保新增的规则已经生效：

   ```
   sudo iptables -L
   ```

以上操作将在CentOS系统上使用iptables工具配置防火墙规则，通过过滤外来的ICMP timestamp请求和外发的ICMP timestamp响应报文来降低ICMP timestamp请求响应漏洞的风险。请确保您具有管理员权限并谨慎操作，以免造成意外的影响。

## ps1:

离线包下载https://www.rpmfind.net/linux/rpm2html/search.php?query=netstat&submit=Search+...&system=centos&arch=

如果难以找到离线包下载，可以采用

```bash
# 1. 安装Downloadonly插件
yum install yum-plugin-downloadonly
# 2. 下载RPM包。默认下载到当前目录,也可以使用`--downloaddir`指定目录下载
# 指定软件包下载路径
yum --downloadonly --downloaddir=/root/rpmTemp/ install iptables-services
# 3. 安装
rpm -ivh *.rpm
```

## 方案二

如果 /etc/sysconfig/ 目录下没有 iptables 文件（就是iptables，而不是iptables-config），需要安装 iptables，安装参考链接：https://www.cnblogs.com/miracle-luna/p/13714709.html

检验系统中有没有iptables服务

```bash
1、停止 firewall 服务
systemctl stop firewalld 
 
2、注销 firewall 服务
systemctl mask firewalld
 
3、安装 iptables 服务
yum install -y iptables 
yum install iptables-services
 
4、启动 iptables 服务
systemctl start iptables
或者
service iptables start
 
5、设置 iptables 开机自启动
systemctl enable iptables
 
6、查看 iptables 状态
systemctl status iptables
或者
service iptables status

```

有了iptables 文件后，修改 iptables 文件
在/etc/sysconfig/iptables 文件中，增加如下文字内容：

```shell
#sample configuration for iptables service
#you can edit this manually or use system-config-firewall
#please do not ask us to add additional ports/services to this default configuration*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT

#解决timestamp问题
-A INPUT -p ICMP --icmp-type timestamp-request -j DROP
-A INPUT -p ICMP --icmp-type timestamp-reply -j DROP
#解决time exceeded问题
-A INPUT -p icmp --icmp-type time-exceeded -j DROP
-A OUTPUT -p icmp --icmp-type time-exceeded -j DROP
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```

保存、重载、重启、查看 iptables 状态

```bash
#保存
service iptables save
#重载
service iptables reload或者systemctl reload iptables
#重启
service iptables restart或者systemctl restart iptables
#查看状态
service iptables status或者systemctl status iptables
```

## ps2:

最终文件：

```shell
# Generated by iptables-save v1.4.21 on Wed Jul  3 16:26:48 2024
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [137:43464]

# 允许已建立和相关的流量
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# 允许ICMP流量
-A INPUT -p icmp -j ACCEPT

# 允许本地回环接口流量
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# 允许SSH访问
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT

# 解决timestamp问题
-A INPUT -p ICMP --icmp-type timestamp-request -j DROP
-A INPUT -p ICMP --icmp-type timestamp-reply -j DROP

# 解决time exceeded问题
-A INPUT -p icmp --icmp-type time-exceeded -j DROP
-A OUTPUT -p icmp --icmp-type time-exceeded -j DROP

# 允许HTTP访问
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp --dport 9200 -j ACCEPT
-A INPUT -p tcp --dport 8848 -j ACCEPT
-A INPUT -p tcp --dport 3306 -j ACCEPT
-I INPUT -s 127.0.0.1 -j ACCEPT

# 拒绝其他所有流量
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited

COMMIT
# Completed on Wed Jul  3 16:26:48 2024
```

```bash
# 1. 修改iptables，然后进行备份
service iptables save
# 2. 此时iptbles文件还原，但是生成iptables.save备份文件
# 3. 从iptables.save文件中导出设置
iptables-restore < /etc/sysconfig/iptables.save
# 4. 重载 
service iptables reload
# 5. 重启
service iptables restart
# 6. 查看配置生效与否
iptables -L -n
```



# nginx  缓冲区错误漏洞(CVE-2022-41741)

# nginx  越界写入漏洞（CVE-2022-41742）

https://mailman.nginx.org/pipermail/nginx-announce/2022/RBRRON6PYBJJM2XIAPQBFBVLR4Q6IHRA.html

## 方案一

http://t.csdnimg.cn/whOGL

使用Nginx的补丁通常需要进行以下步骤。请注意，操作系统和环境可能会有所不同，因此请确保在生产环境中执行这些步骤之前备份您的配置文件和数据。

下面是通常情况下如何应用Nginx补丁的步骤：

1. **下载补丁文件**：
   - 使用您的浏览器或者命令行工具，从提供的链接下载补丁文件。在这种情况下，您可以从以下链接下载补丁：[http://nginx.org/download/patch.2022.mp4.txt](http://nginx.org/download/patch.2022.mp4.txt)

2. **备份配置文件和数据**：
   - 在应用补丁之前，建议您先备份Nginx的配置文件和相关数据，以防意外情况发生。

3. **应用补丁**：
   - 使用patch命令将下载的补丁文件应用到Nginx源代码中。例如，您可以使用以下命令应用补丁：
     ```
     patch -p0 < patch.2022.mp4.txt
     ```

4. **重新编译和安装Nginx**：
   
   - 确保重新编译Nginx源代码，并安装新的可执行文件。具体操作可能因系统和版本而异，通常的步骤包括：
     ```
     ./configure
     make
     make install
     ```
   
5. **重启Nginx服务**：
   - 在成功安装补丁后，确保重新启动Nginx服务以使更改生效。您可以使用以下命令重启Nginx服务：
     ```
     service nginx restart
     ```

6. **测试**：
   - 最后，建议您测试Nginx服务器以确保一切正常运行，并验证补丁已成功应用。

请注意，以上步骤是一般情况下应用Nginx补丁的步骤。根据您的具体环境和需求，可能会有所不同。在操作前，请确保了解您的环境和对系统的影响，以及确保在生产环境中进行充分测试。如果您不确定如何执行上述步骤，请寻求专业支持或者咨询Nginx官方文档。

https://blog.csdn.net/weixin_43171019/article/details/136887397

## 方案二

https://zuiyl.blog.csdn.net/article/details/127788119

1. 查看当前`nginx`版本

```bash
# cd /usr/local/nginx/sbin/
./nginx -V
```

2. 下载新版本nginx-1.23.1压缩包，并停止nginx服务

```bash
#查看当前nginx进程
ps -ef|grep nginx

#停止nginx服务
/usr/local/nginx/sbin/nginx -s stop
```

3. 备份旧版本/usr/local/nginx/sbin/目录下的nginx

```bash
# 备份旧版本/usr/local/nginx/sbin/目录下的nginx
mv nginx nginxold
```

4. 解压新版本

```bash
tar -zxvf nginx-1.23.4.tar.gz 
```

5.  进入解压目录/root/nginx-1.23.1，配置编译

```bash
# 如果历史版本nginx路径不是默认路径，需要在 ./configure中追加上对应参数，默认为/usr/local/nginx。如：./configure --prefix=/home/app/nginx

# 步骤一：执行配置，这里默认为安装在/usr/local/nginx。
./configure
# 步骤二：执行编译(只编译不安装)
make
```

6. 将新版nginx的objs目录下的nginx文件，拷贝到/usr/local/nginx/sbin目录下

```bash
# 注意：nginx版本升级不会覆盖配置文件，但以防万一升级前请先备份配置文件(路径：/usr/local/nginx/conf/nginx.conf )
```

7. 测试&验证`/usr/local/nginx/sbin`

```bash
# 测试新版本nginx配置是否正常
./nginx -t
# 验证版本号
./nginx -V
```

8. 启动nginx

```bash
/usr/local/nginx/sbin/nginx # 启动
```



# 目标可能存在Apache Log4j2 远程代码执行漏洞(CVE-2021-44228)

![image-20240702134110775](.\毓璜顶2024-07-02.assets\image-20240702134110775.png)

# Elasticsearch 未授权访问【原理扫描】

要在Elasticsearch的配置文件中配置网络绑定地址以限制对Elasticsearch端口的访问，您可以按照以下详细配置流程进行操作。您可以指定一个IP地址范围或CIDR表示法来定义一个网段。以下是如何配置一个网段内所有IP地址都可以访问Elasticsearch的步骤：

1. 打开Elasticsearch的配置文件elasticsearch.yml：
   ```
   vi /path/to/elasticsearch/config/elasticsearch.yml
   ```

2. 在配置文件中添加以下行来配置允许特定网段内的所有IP地址访问：
   ```
   network.host: 192.168.1.0/24
   ```

   这里的`192.168.1.0/24`表示一个CIDR表示法，它代表了IP地址范围为`192.168.1.0`到`192.168.1.255`的所有IP地址。您也可以根据需要调整CIDR表示法。

3. 保存配置文件并退出编辑器。

4. 重新启动Elasticsearch服务以使配置更改生效：
   ```
   sudo service elasticsearch restart
   ```

这样配置后，所有在`192.168.1.0/24`网段内的IP地址都将被允许访问Elasticsearch服务。这种配置方式非常方便，特别适合在内部网络中使用，以确保只有特定网段内的设备可以访问Elasticsearch服务。

请确保仔细检查网络配置，以确保只有授权的IP地址范围被允许访问Elasticsearch，以提高服务器的安全性。如果您有任何疑问或需要进一步协助，请随时告诉我。

# Elasticsearch 不受控制的资源消耗（ESA-2023-13）

https://discuss.elastic.co/t/elasticsearch-8-9-0-7-17-13-security-update/343616

https://www.elastic.co/cn/support/matrix#matrix_jvm

已发现 Elasticsearch 处理 HTTP 层传入请求的方式存在问题。未经身份验证的用户可以通过发送一定数量的格式错误的 HTTP 请求来强制 Elasticsearch 节点退出并出现 OutOfMemory 错误。

该问题是由 Elastic Engineering 发现的，我们没有迹象表明该问题已被人们所知或正在被广泛利用。

**受影响的版本：**
Elasticsearch 版本 7.17.12 及以上版本 8.0.0 至 8.8.2

Elastic Cloud Enterprise 最高版本 2.13.3 和 3.6.0，因为这些版本在受影响的版本中包含 Elasticsearch 系统集群。

## 解决方案和缓解措施：

用户应升级到 Elasticsearch 版本 7.17.13 和 8.9.0 及更高版本。
用户应升级到 Elastic Cloud Enterprise 版本 2.13.4 和 3.6.1

**CVSSv3.1：** 7.5（高）AV：N/AC：L/PR：N/UI：N/S：U/C：N/I：N/A：H
**CVE ID：** CVE-2023-31418

## 操作步骤：

1. 停止老版本es

   ```bash
   ps aux | grep elastic
   kill -9 8848
   ```

2. 使用root角色解压tar

   ```bash
   tar -xzvf elasticsearch-7.17.13-linux-x86_64.tar.gz
   ```

3. 使用root角色赋予es的文件权限

   ```bash
   chown -R es /usr/local/es/elasticsearch-7.17.13
   ```

4. 切换es用户，并且备份两个版本的config文件

   ```bash
   su es
   tar -zcvf config.tar.gz /usr/local/es/elasticsearch-7.17.13/config
   ```

5. 将原本es的config配置文件，直接转移给新es

   ```bash
   cp -rf /usr/local/es/elasticsearch-7.6.1/config/* /usr/local/es/elasticsearch-7.17.13/config/
   ```

6. 开启es

   ```bash
   ./elasticsearch-7.17.13/bin/elasticsearch # 第一次运行前端跑一遍
   ./elasticsearch-7.17.13/bin/elasticsearch -d # 后端运行
   ```

7. 如果报错java -version的问题，需要在`/etc/profile`文件中暴露`export ES_JAVA_HOME=/path/to/java`

   ```bash
   source /etc/profile # 重新加载profile文件
   ```

   

# 可通过HTTP获取远端WWW服务信息

![img-v2-b485eb4c9fb015e9f29a526e11491b89_720w](.\毓璜顶2024-07-02.assets\v2-b485eb4c9fb015e9f29a526e11491b89_720w.webp)

通过这个 HTTP 的请求得到的 `Response Headers` 里我们可以查看到一个信息是 `Server: Nginx` 说明对方使用的是 `Nginx` 做 `web` 服务，可以为下一步攻击提供信息，试探 `Nginx` 某个版本的漏洞发起攻击等。 对于公司业务来说，这个确实是有安全隐患的，虽然定义为低风险，还是应该要修复的，修复方式是改变HTTP服务器的缺省 banner。

### 操作步骤

1. 下载、解压补丁到源码包src目录

   ```bash
   tar -zxvf headers-more-nginx-module-0.30.tar.gz
   ```

2. 查看nginx版本及原来的编译方法

   ```bash
   cd /usr/local/nginx/sbin
   # 查看安装参数，拷贝 configure arguments 后的安装参数。
   ./nginx -V
   ```

   ![img-1541633-20231102135133116-2141031406](.\毓璜顶2024-07-02.assets\1541633-20231102135133116-2141031406.png)

3. 进入nginx源码包 ，编译

   ```bash
   # 进入nginx源码包编译
   ./configure
   # 原有的编译后加上
   --add-module=/home/headers-more-nginx-module-0.34  # （解压路径）
   ```

4. make(不要进行make install，否则就是覆盖安装)

   ```bash
   make
   
   # 备份原有已安装好的nginx
   
   cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak
   
   # 将刚刚编译好的nginx覆盖掉原有的nginx（这个时候nginx要停止状态）
   # 编译生成的nginx程序在源码包objs路径下
   
   cp ./objs/nginx /usr/local/nginx/sbin/
   
   ```

5. 修改nginx配置文件/usr/local/nginx/conf/nginx.conf

   ```shell
   # Nginx.conf 的 http 中添加 下面一行
   
   more_clear_headers 'Server';
   ```

6. 查看nginx版本，看是否已经加入成功

   ```bash
   /usr/local/nginx/sbin/nginx -V
   ```

7. 启动nginx：

   ```bash
   cd /usr/local/nginx/sbin
   
   ./nginx  # （重启：./nginx -s reload）
   ```


# ElasticSearch开启权限认证

> ElasticSearch版本 7.6.1
> 服务器版本CentOS 7.4

### 问题描述

> 项目等保协议扫描出ES漏洞：检测到ES(ElasticSearch) 数据库没有开启授权认证，建议开启授权认证，防止非法访问

### 解决步骤

#### 一、 生成证书：

> 注： 切换ES用户，找到ES的部署路径
> 输入    ./bin/elasticSearch-certutil ca

碰到第一个直接回车 文件将会生成在当前文件夹下
碰到第二个输入密码，例如123456
![img-939bb4ae986c4f12940455df54dca2e6](.\毓璜顶2024-07-02.assets\939bb4ae986c4f12940455df54dca2e6.png)
完成后会生成一个文件：elastic-stack-ca.p12

#### 二、 生成秘钥

```base
./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
```

第一个输入密码后回车
第二个不需要输入直接回车
第三个确认密码后回车，之后生成一个文件：elastic-certificates.p12
![img-c1dc8954e2614f36bd0ba1876d732d2f](.\毓璜顶2024-07-02.assets\c1dc8954e2614f36bd0ba1876d732d2f.png)

#### 三、将凭证迁移到指定目录

> 如果是集群，需要每个节点的服务器都要把elastic-certificates.p12（上述方法生成）这个文件移动到每一个es安装目录的相同路径下

```bash
# 先创建目录
mkdir ./config/certificates

# 移动凭证至指定目录下
mv ./elastic-certificates.p12 ./config/certificates/

# 赋值权限，不然会出问题
chmod 777 ./config/certificates/elastic-certificates.p12
```

#### 五、修改配置文件（每一台es都需要添加）

```bash
# 打开配置文件
vi ./config/elasticsearch.yml
# 输入如下配置（原配置中已有的可忽略）
```

```bash
# 跨域
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization,X-Requested-With,Content-Type,Content-Length

xpack.security.enabled: true
xpack.security.authc.accept_default_password: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: 【es的安装路径】/config/certificates/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: 【es的安装路径】/config/certificates/elastic-certificates.p12

```

#### 六、在节点上添加密码（集群时需每台es都需要操作）

```bash
./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password

```

输入密码：第一步中设置的密码，例如本样例中的123456

```bash
./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password

```

输入密码：第一步中设置的密码，例如本样例中的123456

#### 七、逐个启动节点

> 注：启动后可以查下日志，是否正常，如果日志异常，需要根据情况进行排查

```bash
./bin/elasticsearch -d
```

#### 八、设置密码

> 此处会设置很多用户账号的密码，最好记录下来，以后会用到
> elastic，apm\_system，kibana，kibana\_system，logstash\_system，beats\_system，remote\_monitoring\_user

```bash
./bin/elasticsearch-setup-passwords  interactive
# 排着设置密码即可
```

#### 九、浏览器查看9200端口

> 默认端口的访问地址为：http\://\[ip]:9200 输入账号密码后查看信息

![img-b68212adda664690afdc872b3757c66c-1720685008142-7](.\毓璜顶2024-07-02.assets\b68212adda664690afdc872b3757c66c-1720685008142-7.png)

#### 十、更新项目服务配置

> 到nacos中 找到生产的配置文件分组，找到 biobank-master-biz-dev.yml 修改如下配置
>
> 此处配置的ES的认证

```java
    elasticsearch:
        bboss:
            elasticsearch:
                rest:
                    hostNames: 192.168.21.244:9200
            # 增加下面的 elasticUser  elasticPassword   
            elasticUser: elastic
            elasticPassword: 123456  



elasticsearch:
  host: 192.168.21.244
  port: 9200
  name: samples_info_hzfck
  # 增加下面的 userName 和 password
  userName: elastic
  password: 123456
```

> 配置gateway：找到 biobank-gateway-dev.yml，到配置最下方 添加如下配置

```java
management:
  endpoint:
    gateway:
      enabled: false
```

#### &#x20;十一、更新最新的程序包

服务器es专用用户    es  es（密码不确定）

es 账号密码   elastic  jyg88891715